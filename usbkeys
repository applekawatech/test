#!/bin/bash

run_hook() {
    echo "Running usbkeys hook..."

    # Check if the mount point exists, create it if not
    if [ ! -d /mnt/encrypted_usb ]; then
        sudo mkdir -p /mnt/encrypted_usb
    fi

    # Mount encrypted USB device
    if sudo cryptsetup luksOpen /dev/disk/by-uuid/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx my_encrypted_usb; then
        sudo mount /dev/mapper/my_encrypted_usb /mnt/encrypted_usb

        # Copy the key file if found
        if [ -f /mnt/encrypted_usb/Ilovemasa.py ]; then
            echo "Key file found, copying to /tmp..."
            sudo cp /mnt/encrypted_usb/Ilovemasa.py /tmp/Ilovemasa.py
        else
            echo "Key file not found on encrypted USB"
            sudo umount /mnt/encrypted_usb
            sudo cryptsetup luksClose my_encrypted_usb
            exit 1
        fi

        # Unmount encrypted USB
        sudo umount /mnt/encrypted_usb
        sudo cryptsetup luksClose my_encrypted_usb
    else
        echo "Failed to open encrypted USB device"
        exit 1
    fi
}

# Run the hook function
run_hook
