#!/bin/bash

run_hook() {
    echo "Running usbkeys hook..."

    # Fixed directory paths
    mount_dir="/mnt/usbkey"
    tmp_dir="/run/tmp"

    # Create the directories if they don't exist
    if [ ! -d "$mount_dir" ]; then
        echo "Creating $mount_dir directory..."
        mkdir -p "$mount_dir"
    fi

    if [ ! -d "$tmp_dir" ]; then
        echo "Creating $tmp_dir directory..."
        mkdir -p "$tmp_dir"
        chmod 1777 "$tmp_dir"  # Set permissions to drwxrwxrwt
    fi

    # Mount USB device
    usb_found=false
    for dev in /dev/disk/by-id/usb*; do
        echo "Trying to mount USB device: $dev"
        if mount -t auto "$dev" "$mount_dir" 2>/dev/null; then
            echo "USB device mounted at $mount_dir"
            usb_found=true
            break
        else
            echo "Failed to mount: $dev"
        fi
    done

    if $usb_found; then
        # Move the key file if found
        if [ -f "$mount_dir/Ilovemasa.py" ]; then
            echo "Key file found, moving to $tmp_dir/Ilovemasa.py"
            mv "$mount_dir/Ilovemasa.py" "$tmp_dir/Ilovemasa.py"
        else
            echo "Key file not found on USB device"
            exit 1
        fi

        # Unmount USB device
        echo "Unmounting USB device..."
        umount "$mount_dir"
    else
        echo "No USB device mounted"
        exit 1
    fi
}

# Run the hook function
run_hook
