#!/bin/bash

run_hook() {
    echo "Running usbkeys hook..."

    # Fixed temporary directory path
    tmp_dir="/run/tmp"

    # Create the directory if it doesn't exist
    if [ ! -d "$tmp_dir" ]; then
        echo "Creating $tmp_dir directory..."
        mkdir -p "$tmp_dir"
        chmod 1777 "$tmp_dir"  # Set permissions to drwxrwxrwt
    fi

    # Mount USB device
    usb_found=false
    for dev in /dev/disk/by-id/usb*; do
        echo "Trying to mount USB device: $dev"
        if mount -t auto "$dev" "$tmp_dir" 2>/dev/null; then
            echo "USB device mounted at $tmp_dir"
            usb_found=true
            break
        else
            echo "Failed to mount: $dev"
        fi
    done

    if $usb_found; then
        # Copy the key file if found
        if [ -f "$tmp_dir/Ilovemasa.py" ]; then
            echo "Key file found, moving to /run/tmp/Ilovemasa.py"
            mv "$tmp_dir/Ilovemasa.py" /run/tmp/Ilovemasa.py
        else
            echo "Key file not found on USB device"
        fi

        # Unmount USB device
        echo "Unmounting USB device..."
        umount "$tmp_dir"
    else
        echo "No USB device mounted"
        exit 1
    fi
}

# Run the hook function
run_hook
